---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "apisix_upstream Resource - terraform-provider-apisix"
subcategory: ""
description: |-
  Manages APISIX Upstreams.
---

# apisix_upstream (Resource)

Manages APISIX Upstreams.

## Example Usage

```terraform
resource "apisix_upstream" "example" {
  name = "Example"
  desc = "Example of the upstream resource usage"
  type = "roundrobin"
  labels = {
    version = "v1"
  }
  nodes = [
    {
      host   = "127.0.0.1"
      port   = 1980
      weight = 1
    },
    {
      host   = "127.0.0.1"
      port   = 1970
      weight = 1
    },
  ]
  keepalive_pool = {
    idle_timeout = 5
    requests     = 10
    size         = 15
  }
  checks = {
    active = {
      host      = "example.com"
      port      = 8888
      timeout   = 5
      http_path = "/status"
      healthy = {
        interval  = 2,
        successes = 1
      }
      unhealthy = {
        interval      = 1
        http_failures = 2
      }
    }
    passive = {
      healthy = {
        http_statuses = [200, 201]
      }
      unhealthy = {
        http_statuses = [500]
        http_failures = 3
        tcp_failures  = 3
      }
    }
  }
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Optional

- `checks` (Attributes) Configures the parameters for the health check. (see [below for nested schema](#nestedatt--checks))
- `desc` (String) Description of usage scenarios.
- `discovery_type` (String) The type of service discovery. Required, if `service_name` is used
- `hash_on` (String) Only valid if the type is chash. Supports Nginx variables (vars), custom headers (header), cookie and consumer. Defaults to vars.
- `keepalive_pool` (Attributes) Sets the `keepalive_pool`. (see [below for nested schema](#nestedatt--keepalive_pool))
- `key` (String) Nginx var
- `labels` (Map of String) Attributes of the Upstream specified as `key-value` pairs.
- `name` (String) Identifier for the Upstream.
- `nodes` (Attributes List) Configures the parameters for the health check. (see [below for nested schema](#nestedatt--nodes))
- `pass_host` (String) Configures the `host` when the request is forwarded to the upstream. Can be one of `pass`, `node` or `rewrite`. Defaults to `pass` if not specified.
- `retries` (Number) Sets the number of retries while passing the request to Upstream using the underlying Nginx mechanism. Setting this to `0` disables retry.
- `retry_timeout` (Number) Timeout to continue with retries. Setting this to `0` disables the retry timeout.
- `scheme` (String) The scheme used when communicating with the Upstream. For an L7 proxy, this value can be one of `http`, `https`, `grpc`, `grpcs`. For an L4 proxy, this value could be one of `tcp`, `udp`, `tls`. Defaults to `http`.
- `service_name` (String) Service name used for service discovery. Can't be used with `nodes`
- `timeout` (Attributes) Sets the timeout (in seconds) for connecting to, and sending and receiving messages to and from the Upstream. (see [below for nested schema](#nestedatt--timeout))
- `tls` (Attributes) Configures the TLS client certificate for the upstream. (see [below for nested schema](#nestedatt--tls))
- `type` (String) Load balancing algorithm to be used, and the default value is `roundrobin`.
Can be one of the following: `roundrobin`, `chash`, `ewma` or `least_conn`
- `upstream_host` (String) Specifies the host of the Upstream request. This is only valid if the `pass_host` is set to `rewrite`.

### Read-Only

- `id` (String) Identifier of the upstream.

<a id="nestedatt--checks"></a>
### Nested Schema for `checks`

Optional:

- `active` (Attributes) Active health check mainly means that APISIX actively detects the survivability of upstream nodes through probes. (see [below for nested schema](#nestedatt--checks--active))
- `passive` (Attributes) Passive health check refers to judging whether the corresponding upstream node is healthy by judging the response status of the request forwarded from APISIX to the upstream node. (see [below for nested schema](#nestedatt--checks--passive))

<a id="nestedatt--checks--active"></a>
### Nested Schema for `checks.active`

Optional:

- `concurrency` (Number) The number of targets to be checked at the same time during the active check.
- `healthy` (Attributes) (see [below for nested schema](#nestedatt--checks--active--healthy))
- `host` (String) The hostname of the HTTP request actively checked.
- `http_path` (String) The HTTP request path that is actively checked.
- `https_verify_certificate` (Boolean) Active check whether to check the SSL certificate of the remote host when HTTPS type checking is used.
- `port` (Number) The host port of the HTTP request that is actively checked.
- `req_headers` (List of String) Active check When using HTTP or HTTPS type checking, set additional request header information.
- `timeout` (Number) The timeout period of the active check (seconds).
- `type` (String) The type of active check. Valid values are `http`, `https`, and `tcp`
- `unhealthy` (Attributes) (see [below for nested schema](#nestedatt--checks--active--unhealthy))

<a id="nestedatt--checks--active--healthy"></a>
### Nested Schema for `checks.active.healthy`

Optional:

- `http_statuses` (List of Number) Active check (healthy node) HTTP or HTTPS type check, the HTTP status code of the healthy node.
- `interval` (Number) Active check (healthy node) check interval (unit: second)
- `successes` (Number) Active check (healthy node) determine the number of times a node is healthy.


<a id="nestedatt--checks--active--unhealthy"></a>
### Nested Schema for `checks.active.unhealthy`

Optional:

- `http_failures` (Number) Active check (unhealthy node) HTTP or HTTPS type check, determine the number of times that the node is not healthy.
- `http_statuses` (List of Number) Active check (unhealthy node) HTTP or HTTPS type check, the HTTP status code of the non-healthy node.
- `interval` (Number) Active check (unhealthy node) check interval (unit: second)
- `tcp_failures` (Number) Active check (unhealthy node) TCP type check, determine the number of times that the node is not healthy.
- `timeouts` (Number) Active check (unhealthy node) to determine the number of timeouts for unhealthy nodes.



<a id="nestedatt--checks--passive"></a>
### Nested Schema for `checks.passive`

Optional:

- `healthy` (Attributes) Passive health check refers to judging whether the corresponding upstream node is healthy by judging the response status of the request forwarded from APISIX to the upstream node. (see [below for nested schema](#nestedatt--checks--passive--healthy))
- `unhealthy` (Attributes) (see [below for nested schema](#nestedatt--checks--passive--unhealthy))

<a id="nestedatt--checks--passive--healthy"></a>
### Nested Schema for `checks.passive.healthy`

Optional:

- `http_statuses` (List of Number) Passive check (healthy node) HTTP or HTTPS type check, the HTTP status code of the healthy node.
- `successes` (Number) Passive checks (healthy node) determine the number of times a node is healthy.


<a id="nestedatt--checks--passive--unhealthy"></a>
### Nested Schema for `checks.passive.unhealthy`

Optional:

- `http_failures` (Number) Passive check (unhealthy node) The number of times that the node is not healthy during HTTP or HTTPS type checking.
- `http_statuses` (List of Number) Passive check (unhealthy node) HTTP or HTTPS type check, the HTTP status code of the non-healthy node.
- `tcp_failures` (Number) Passive check (unhealthy node) When TCP type is checked, determine the number of times that the node is not healthy.
- `timeouts` (Number) Passive checks (unhealthy node) determine the number of timeouts for unhealthy nodes.




<a id="nestedatt--keepalive_pool"></a>
### Nested Schema for `keepalive_pool`

Required:

- `idle_timeout` (Number)
- `requests` (Number)
- `size` (Number)


<a id="nestedatt--nodes"></a>
### Nested Schema for `nodes`

Required:

- `host` (String)
- `port` (Number)

Optional:

- `weight` (Number)


<a id="nestedatt--timeout"></a>
### Nested Schema for `timeout`

Required:

- `connect` (Number)
- `read` (Number)
- `send` (Number)


<a id="nestedatt--tls"></a>
### Nested Schema for `tls`

Optional:

- `client_cert` (String) Sets the client certificate while connecting to a TLS Upstream. Can't be used with `tls.client_cert_id`.
- `client_cert_id` (String) The ID of the client certificate to use for TLS. Can't be used with `tls.client_cert` and `tls.client_key`.
- `client_key` (String, Sensitive) Sets the client key while connecting to a TLS Upstream. Can't be used with `tls.client_cert_id`.

## Import

Import is supported using the following syntax:

```shell
# Upstream can be imported by specifying the numeric identifier.
terraform import apisix_upstream.example 123
```
